<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StemTube Web</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1762213749">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jam.css') }}">
    <!-- CSRF protection is disabled for this application -->
    <!-- Split.js pour le redimensionnement des colonnes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.5/split.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>StemTube Web</h1>
            <div class="header-buttons">
                <div class="on-stage-indicator" id="onStageIndicator" style="display:none;" onclick="switchToTab('jam')">
                    <span class="on-stage-dot"></span>
                    <span class="on-stage-text">ON STAGE</span>
                </div>
                <div class="user-info">
                    <i class="fas fa-user"></i>
                    <span class="username">{{ current_username }}</span>
                </div>
                <div class="logout-button" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="settings-button" id="settingsButton">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
        </header>
        
        <main id="split-main">
            <!-- Left Column: Dynamic content based on active tab -->
            <div class="column search-column" id="left-panel">
                <!-- YouTube Search (for Downloads, Search tabs) -->
                <div class="left-panel-content" id="searchContent">
                    <div class="search-container">
                        {% if enable_youtube %}
                        <div class="search-mode-container">
                            <label for="searchMode">Mode:</label>
                            <div class="segmented-control" id="searchMode">
                                <button class="segment active" data-mode="search">üîç Search</button>
                                <button class="segment" data-mode="url">üìÅ Upload</button>
                            </div>
                        </div>

                        <div class="search-input-container" id="searchInputContainer">
                            <input type="text" id="searchInput" placeholder="Search YouTube...">
                            <select id="resultsCount">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="50">50</option>
                            </select>
                            <button id="searchButton"><i class="fas fa-search"></i></button>
                        </div>
                        {% endif %}

                        <div class="file-upload-container" id="fileUploadContainer" style="{% if enable_youtube %}display: none;{% else %}display: block;{% endif %}">
                            {% if not enable_youtube %}
                            <h3 style="margin-bottom: 15px; color: var(--text-primary);">Upload Audio/Video File</h3>
                            {% endif %}
                            <div class="file-upload-area" id="fileUploadArea">
                                <input type="file" id="fileInput" accept="audio/*,video/*,.mp3,.wav,.flac,.m4a,.aac,.ogg,.wma,.mp4,.avi,.mkv,.mov,.webm" style="display: none;">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click or drag audio/video file here</p>
                                <p class="file-info">Supported: MP3, WAV, FLAC, M4A, AAC, OGG, WMA, MP4, AVI, MKV, MOV, WEBM</p>
                            </div>
                            <div class="file-selected-info" id="fileSelectedInfo" style="display: none;">
                                <i class="fas fa-file-audio"></i>
                                <span id="selectedFileName"></span>
                                <button id="uploadButton" class="upload-button"><i class="fas fa-upload"></i> Upload & Process</button>
                                <button id="clearFileButton" class="clear-button"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="uploadProgressFill"></div>
                                </div>
                                <p id="uploadProgressText">Uploading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="search-results" id="searchResults">
                        <!-- Search results will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Downloads List (for Extractions tab) -->
                <div class="left-panel-content" id="downloadsContent" style="display: none;">
                    <div class="panel-header">
                        <h3>Available Downloads</h3>
                        <p class="panel-subtitle">Click on a download to start extraction</p>
                    </div>
                    <div class="downloads-list-for-extraction" id="downloadsListForExtraction">
                        <!-- Downloads available for extraction will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Extractions List (for Mixer tab) -->
                <div class="left-panel-content" id="extractionsContent" style="display: none;">
                    <div class="panel-header">
                        <h3>Your Extractions</h3>
                        <p class="panel-subtitle">Click on an extraction to load in mixer</p>
                    </div>
                    <div class="extractions-list-for-mixer" id="extractionsListForMixer">
                        <!-- Extractions available for mixing will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Admin Menu (for Admin tab) -->
                {% if current_user.is_admin %}
                <div class="left-panel-content" id="adminMenuContent" style="display: none;">
                    <div class="panel-header">
                        <h3>Administration</h3>
                        <p class="panel-subtitle">Select an administrative function</p>
                    </div>
                    <div class="admin-menu">
                        <button class="admin-menu-item active" data-admin-section="users">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                        </button>
                        <button class="admin-menu-item" data-admin-section="logs">
                            <i class="fas fa-file-alt"></i>
                            <span>Browser Logs</span>
                        </button>
                        <button class="admin-menu-item" data-admin-section="cleanup">
                            <i class="fas fa-broom"></i>
                            <span>System Cleanup</span>
                        </button>
                        <button class="admin-menu-item" data-admin-section="settings">
                            <i class="fas fa-cogs"></i>
                            <span>System Settings</span>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Right Column: Downloads and Extractions -->
            <div class="column management-column" id="right-panel">
                <div class="tabs">
                    {% if current_user.is_admin %}
                    <button class="tab-button" data-tab="admin">Admin</button>
                    {% endif %}
                    <button class="tab-button" data-tab="downloads">My Library</button>
                    <button class="tab-button" data-tab="library">Global Library</button>
                    <button class="tab-button" data-tab="mixer">Mixer</button>
                    <button class="tab-button" data-tab="jam"><i class="fas fa-users"></i> Jam</button>
                </div>
                
                {% if current_user.is_admin %}
                <div class="tab-content" id="adminTab">
                    <!-- Users Administration Section -->
                    <div class="admin-section" id="usersSection">
                        <h2>Users Administration</h2>
                        <div class="admin-container">
                            <div class="loading">Loading administration interface...</div>
                            <iframe id="adminFrame" src="/admin/embedded" style="width: 100%; height: 800px; min-height: 800px; border: none; display: none;"></iframe>
                        </div>
                    </div>

                    <!-- Browser Logs Configuration Section -->
                    <div class="admin-section" id="logsSection" style="display: none;">
                        <h2>Browser Logs Configuration</h2>
                        <div class="logs-container" style="padding: 20px;">
                            <div class="logs-warning" style="background: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <p style="margin: 0; color: #dc3545;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Warning:</strong> Enabling browser logs can generate many HTTP requests.
                                    Keep disabled when using tunneling services like Ngrok (600 req/min limit).
                                </p>
                            </div>

                            <!-- Preset Buttons -->
                            <div class="logs-presets" style="display: flex; gap: 10px; margin-bottom: 25px;">
                                <button id="presetDisabledBtn" class="logs-preset-btn active" data-preset="disabled" style="flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #dc3545; background: rgba(220, 53, 69, 0.1); color: #dc3545; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-ban"></i><br>
                                    <span>Disabled</span><br>
                                    <small style="font-weight: normal; opacity: 0.8;">Recommended</small>
                                </button>
                                <button id="presetProductionBtn" class="logs-preset-btn" data-preset="production" style="flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #28a745; background: transparent; color: #28a745; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-check"></i><br>
                                    <span>Production</span><br>
                                    <small style="font-weight: normal; opacity: 0.8;">Errors only</small>
                                </button>
                                <button id="presetDevelopmentBtn" class="logs-preset-btn" data-preset="development" style="flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #ffc107; background: transparent; color: #ffc107; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-code"></i><br>
                                    <span>Development</span><br>
                                    <small style="font-weight: normal; opacity: 0.8;">All logs</small>
                                </button>
                            </div>

                            <!-- Current Status -->
                            <div class="logs-status" style="background: var(--bg-secondary); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; color: var(--text-secondary);">Current Status</h4>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span id="logsStatusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #dc3545;"></span>
                                    <span id="logsStatusText" style="font-weight: 600;">Logs Disabled</span>
                                </div>
                            </div>

                            <!-- Detailed Settings Form -->
                            <details style="background: var(--bg-secondary); border-radius: 8px; padding: 15px;">
                                <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary);">
                                    <i class="fas fa-cog"></i> Advanced Settings
                                </summary>
                                <form id="browserLoggingForm" style="margin-top: 15px;">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="loggingEnabled" style="width: 18px; height: 18px;">
                                            <span>Enable Server Logging</span>
                                        </label>
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label for="logLevel" style="display: block; margin-bottom: 5px;">Minimum Log Level</label>
                                        <select id="logLevel" style="width: 100%; padding: 8px; border-radius: 4px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color);">
                                            <option value="debug">Debug (All messages)</option>
                                            <option value="info">Info</option>
                                            <option value="warn">Warnings only</option>
                                            <option value="error">Errors only (Recommended)</option>
                                        </select>
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label>Flush Interval: <span id="flushIntervalValue">60</span> seconds</label>
                                        <input type="range" id="flushInterval" min="10" max="300" step="10" value="60" style="width: 100%;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label>Buffer Size: <span id="bufferSizeValue">50</span> entries</label>
                                        <input type="range" id="bufferSize" min="50" max="500" step="50" value="50" style="width: 100%;">
                                    </div>

                                    <button type="submit" class="btn" style="background: var(--accent-color); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </form>
                                <div id="loggingConfigMessage" style="margin-top: 15px; display: none;"></div>
                            </details>
                        </div>
                    </div>

                    <!-- Cleanup Section -->
                    <div class="admin-section" id="cleanupSection" style="display: none;">
                        <h2>System Cleanup</h2>
                        <div class="cleanup-container">
                            <!-- Cleanup Controls -->
                            <div class="cleanup-controls">
                                <div class="bulk-actions">
                                    <label class="bulk-select">
                                        <input type="checkbox" id="selectAllDownloads"> Select All
                                    </label>
                                    <button class="action-button danger" id="bulkDeleteButton" disabled>
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                    <button class="action-button warning" id="bulkResetExtractionsButton" disabled>
                                        <i class="fas fa-undo"></i> Reset Selected Extractions
                                    </button>
                                    <button class="action-button secondary" id="refreshCleanupButton">
                                        <i class="fas fa-refresh"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Downloads Table -->
                            <div class="cleanup-table-container">
                                <table class="cleanup-table" id="cleanupTable">
                                    <thead>
                                        <tr>
                                            <th class="checkbox-column">
                                                <input type="checkbox" id="headerSelectAll">
                                            </th>
                                            <th class="sortable" data-sort="video_id">Video ID</th>
                                            <th class="sortable" data-sort="title">Title</th>
                                            <th class="sortable" data-sort="users">Users</th>
                                            <th class="sortable" data-sort="file_size">Size</th>
                                            <th class="sortable" data-sort="extracted">Extracted</th>
                                            <th class="sortable" data-sort="created_at">Created</th>
                                            <th class="actions-column">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cleanupTableBody">
                                        <tr class="loading-row">
                                            <td colspan="8">
                                                <div class="loading">Loading downloads...</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Bulk Operation Progress -->
                            <div class="bulk-progress" id="bulkProgress" style="display: none;">
                                <div class="progress-info">
                                    <span id="bulkProgressText">Processing...</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="bulkProgressFill"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Settings Section -->
                    <div class="admin-section" id="settingsSection" style="display: none;">
                        <h2>System Settings</h2>
                        <div class="system-settings-container">
                            <!-- System Status Cards -->
                            <div class="system-info-grid">
                                <div class="info-card" id="gpuInfoCard">
                                    <div class="info-card-header">
                                        <i class="fas fa-microchip"></i>
                                        <span>GPU Status</span>
                                    </div>
                                    <div class="info-card-body">
                                        <div class="status-indicator" id="gpuStatusIndicator">
                                            <span class="status-dot"></span>
                                            <span class="status-text">Checking...</span>
                                        </div>
                                        <p class="info-detail" id="gpuName"></p>
                                    </div>
                                </div>

                                <div class="info-card" id="ffmpegInfoCard">
                                    <div class="info-card-header">
                                        <i class="fas fa-film"></i>
                                        <span>FFmpeg Status</span>
                                    </div>
                                    <div class="info-card-body">
                                        <div class="status-indicator" id="ffmpegStatusIndicator">
                                            <span class="status-dot"></span>
                                            <span class="status-text">Checking...</span>
                                        </div>
                                        <p class="info-detail" id="ffmpegPath"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Settings Form -->
                            <div class="settings-form-section">
                                <h3>Configuration</h3>
                                <form id="systemSettingsForm" class="settings-form-grid">
                                    <div class="setting-group">
                                        <label for="adminDownloadsDirectory">
                                            <i class="fas fa-folder"></i> Downloads Directory
                                        </label>
                                        <input type="text" id="adminDownloadsDirectory" placeholder="/path/to/downloads">
                                        <small class="setting-hint">Changes require server restart</small>
                                    </div>

                                    <div class="setting-group">
                                        <label for="adminMaxDownloads">
                                            <i class="fas fa-download"></i> Max Concurrent Downloads
                                        </label>
                                        <input type="number" id="adminMaxDownloads" min="1" max="10" value="3">
                                    </div>

                                    <div class="setting-group">
                                        <label for="adminMaxExtractions">
                                            <i class="fas fa-cut"></i> Max Concurrent Extractions
                                        </label>
                                        <input type="number" id="adminMaxExtractions" min="1" max="5" value="1">
                                    </div>

                                    <div class="setting-group">
                                        <label for="adminUseGpu">
                                            <i class="fas fa-bolt"></i> Use GPU for Extraction
                                        </label>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="adminUseGpu" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div class="setting-group">
                                        <label for="adminLyricsModel">
                                            <i class="fas fa-music"></i> Whisper Model (Lyrics)
                                        </label>
                                        <select id="adminLyricsModel">
                                            <option value="tiny">tiny (fastest)</option>
                                            <option value="base">base</option>
                                            <option value="small">small</option>
                                            <option value="medium" selected>medium (recommended)</option>
                                            <option value="large">large</option>
                                            <option value="large-v2">large-v2</option>
                                            <option value="large-v3">large-v3 (best)</option>
                                        </select>
                                    </div>

                                    <div class="setting-group">
                                        <label for="adminStemModel">
                                            <i class="fas fa-layer-group"></i> Default Stem Model
                                        </label>
                                        <select id="adminStemModel">
                                            <option value="htdemucs" selected>htdemucs (recommended)</option>
                                            <option value="htdemucs_ft">htdemucs_ft (fine-tuned)</option>
                                            <option value="htdemucs_6s">htdemucs_6s (6 stems)</option>
                                            <option value="mdx_extra">mdx_extra (vocal focus)</option>
                                        </select>
                                    </div>
                                </form>
                            </div>

                            <!-- Action Buttons -->
                            <div class="settings-actions">
                                <button type="button" class="btn btn-primary" id="saveSystemSettingsBtn">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                                <button type="button" class="btn btn-warning" id="restartServerBtn">
                                    <i class="fas fa-redo"></i> Restart Server
                                </button>
                            </div>

                            <!-- Restart Warning -->
                            <div class="restart-warning" id="restartWarning" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Downloads directory changed. Server restart required for changes to take effect.</span>
                            </div>

                            <!-- YouTube Cookies Section -->
                            <div class="settings-form-section" style="margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                                <h3><i class="fas fa-cookie-bite"></i> YouTube Cookies</h3>

                                <div id="cookies-status" class="info-card" style="margin-bottom: 15px;">
                                    <div class="info-card-body">
                                        <p><i class="fas fa-spinner fa-spin"></i> Checking...</p>
                                    </div>
                                </div>

                                <!-- Primary method: File upload -->
                                <div class="cookies-instructions" style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--text-secondary);">
                                        <strong>Upload cookies.txt file:</strong>
                                    </p>
                                    <ol style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);">
                                        <li>Install browser extension: <strong>"Get cookies.txt LOCALLY"</strong> (Chrome/Edge) or <strong>"cookies.txt"</strong> (Firefox)</li>
                                        <li>Go to <a href="https://youtube.com" target="_blank">youtube.com</a> and <strong>log in</strong> to your Google account</li>
                                        <li>Click the extension to export cookies (select "Current Site" or youtube.com)</li>
                                        <li>Upload the exported file below</li>
                                    </ol>
                                </div>

                                <div class="settings-actions" style="gap: 10px; flex-wrap: wrap;">
                                    <input type="file" id="cookiesFileInput" accept=".txt" style="display: none;">
                                    <button type="button" class="btn btn-primary" id="uploadCookiesFileBtn">
                                        <i class="fas fa-upload"></i> Upload cookies.txt
                                    </button>
                                    <button type="button" class="btn btn-danger" id="deleteCookiesBtn" disabled>
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>

                                <!-- Secondary method: Bookmarklet (collapsed) -->
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-size: 0.85rem; color: var(--text-muted);">
                                        <i class="fas fa-chevron-right"></i> Alternative: Bookmarklet (limited)
                                    </summary>
                                    <div style="margin-top: 10px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid #f0ad4e;">
                                        <p style="margin: 0 0 10px 0; font-size: 0.8rem; color: #f0ad4e;">
                                            <i class="fas fa-exclamation-triangle"></i> The bookmarklet cannot capture HttpOnly cookies required for YouTube authentication. Use the file upload method above for reliable results.
                                        </p>
                                        <button type="button" class="btn btn-secondary" id="generateBookmarkletBtn" style="font-size: 0.85rem;">
                                            <i class="fas fa-magic"></i> Generate Bookmarklet
                                        </button>
                                        <div id="bookmarklet-container" style="display: none; margin-top: 10px;">
                                            <a id="bookmarklet-link" href="#"
                                               style="display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #ff0000, #cc0000); color: white; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 0.85rem;"
                                               onclick="alert('Drag this link to your bookmarks bar!'); return false;">
                                                StemTube Cookies
                                            </a>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="tab-content" id="downloadsTab">
                    <h2>My Library</h2>
                    <div class="user-management-controls" id="downloadsManagementControls" style="display: none;">
                        <div class="bulk-actions">
                            <label class="bulk-select">
                                <input type="checkbox" id="selectAllUserDownloads"> Select All
                            </label>
                            <button class="action-button danger" id="bulkRemoveDownloadsButton" disabled>
                                <i class="fas fa-eye-slash"></i> Remove Selected from My List
                            </button>
                        </div>
                    </div>
                    <div class="library-container" id="downloadsContainer">
                        <!-- Library items (downloads + extractions) will be dynamically added here -->
                    </div>
                </div>
                
                <div class="tab-content" id="libraryTab">
                    <h2>Global Library</h2>
                    <div class="library-controls">
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label>Show:</label>
                                <div class="filter-buttons">
                                    <button class="filter-button active" data-filter="all">All</button>
                                    <button class="filter-button" data-filter="downloads">Downloads</button>
                                    <button class="filter-button" data-filter="extractions">Extractions</button>
                                </div>
                            </div>
                            <div class="search-group">
                                <input type="text" id="librarySearchInput" placeholder="Search library...">
                                <button id="librarySearchButton"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="library-stats">
                            <span id="libraryItemCount">Loading...</span>
                        </div>
                    </div>
                    <div class="library-container" id="libraryContainer">
                        <!-- Library items will be dynamically added here -->
                    </div>
                </div>
                
                <div class="tab-content" id="mixerTab">
                    <div class="mixer-header-with-title">
                        <h2>Audio Mixer</h2>
                        <span class="mixer-song-title" id="mixer-song-title-display"></span>
                    </div>
                    <div class="mixer-container" id="mixerContainer">
                        <div id="loading" class="loading">Chargement des stems audio...</div>
                        <iframe id="mixerFrame" src="/mixer" style="width: 100%; height: 800px; min-height: 800px; border: none; display: none;"></iframe>
                    </div>
                </div>

                <div class="tab-content" id="jamTab">
                    <!-- Jam Session content rendered by jam-tab.js -->
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal-compact">
            <div class="modal-header">
                <h2>User Settings</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Appearance</h3>
                    <div class="setting-item">
                        <label for="themeSelect">Theme:</label>
                        <select id="themeSelect">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                </div>

                {% if current_user.is_admin %}
                <div class="settings-section admin-settings-link">
                    <p>
                        <i class="fas fa-cogs"></i>
                        For system settings (downloads, GPU, models), go to
                        <a href="#" id="goToAdminSettingsLink">Admin Panel > System Settings</a>
                    </p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button id="saveSettingsButton">Save Settings</button>
            </div>
        </div>
    </div>
    
    {% if enable_youtube %}
    <div class="modal" id="downloadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Download Options</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="video-info">
                    <img id="downloadThumbnail" src="" alt="Video Thumbnail">
                    <h3 id="downloadTitle"></h3>
                </div>

                <div class="download-options">
                    <div class="option-item">
                        <label for="downloadType">Download Type:</label>
                        <select id="downloadType">
                            <option value="audio" selected>Audio (MP3)</option>
                            <option value="video">Video (MP4)</option>
                        </select>
                    </div>

                    <div class="option-item" id="videoQualityContainer">
                        <label for="videoQuality">Video Quality:</label>
                        <select id="videoQuality">
                            <option value="best">Best</option>
                            <option value="1080p">1080p</option>
                            <option value="720p" selected>720p</option>
                            <option value="480p">480p</option>
                            <option value="360p">360p</option>
                        </select>
                    </div>

                    <div class="option-item" id="audioQualityContainer">
                        <label for="audioQuality">Audio Quality:</label>
                        <select id="audioQuality">
                            <option value="best" selected>Best</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="startDownloadButton">Start Download</button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="modal" id="extractionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Extraction Options</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="audio-info">
                    <h3 id="extractionTitle"></h3>
                    <p id="extractionPath"></p>
                </div>
                
                <div class="extraction-options">
                    <div class="option-item">
                        <label for="stemModel">Stem Model:</label>
                        <select id="stemModel" class="stem-model-select">
                            <option value="htdemucs" data-stems="vocals,drums,bass,other" selected>htdemucs (recommended)</option>
                            <option value="htdemucs_ft" data-stems="vocals,drums,bass,other">htdemucs_ft (fine-tuned)</option>
                            <option value="htdemucs_6s" data-stems="vocals,drums,bass,guitar,piano,other">htdemucs_6s (6 stems)</option>
                            <option value="mdx_extra" data-stems="vocals,drums,bass,other">mdx_extra (vocal focus)</option>
                            <option value="mdx_extra_q" data-stems="vocals,drums,bass,other" disabled title="Requires diffq package">mdx_extra_q (requires diffq - unavailable)</option>
                        </select>
                        <p id="modelDescription" class="model-description"></p>
                    </div>
                    
                    <div class="option-item">
                        <label>Select Stems to Extract:</label>
                        <div class="stem-checkboxes" id="stemCheckboxes">
                            <div class="stem-checkbox">
                                <input type="checkbox" id="vocalsCheckbox" checked>
                                <label for="vocalsCheckbox">Vocals</label>
                            </div>
                            <div class="stem-checkbox">
                                <input type="checkbox" id="drumsCheckbox" checked>
                                <label for="drumsCheckbox">Drums</label>
                            </div>
                            <div class="stem-checkbox">
                                <input type="checkbox" id="bassCheckbox" checked>
                                <label for="bassCheckbox">Bass</label>
                            </div>
                            <div class="stem-checkbox">
                                <input type="checkbox" id="otherCheckbox" checked>
                                <label for="otherCheckbox">Other</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-item">
                        <div class="two-stem-mode">
                            <input type="checkbox" id="twoStemMode">
                            <label for="twoStemMode">Two-Stem Mode (Isolate one stem vs. everything else)</label>
                        </div>
                    </div>
                    
                    <div class="option-item" id="primaryStemContainer" style="display: none;">
                        <label for="primaryStem">Primary Stem:</label>
                        <select id="primaryStem">
                            <option value="vocals" selected>Vocals</option>
                            <option value="drums">Drums</option>
                            <option value="bass">Bass</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="startExtractionButton">Start Extraction</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Global variables MUST be defined before app.js loads -->
    <script>
        // Global admin status variable for JavaScript
        const isAdmin = {% if current_user.is_admin %}true{% else %}false{% endif %};
        // YouTube features flag (controlled per-user via admin panel)
        const enableYoutube = {% if enable_youtube %}true{% else %}false{% endif %};
    </script>
    <!-- Dynamic logging with admin-controlled config - timestamp forces cache refresh -->
    <script src="{{ url_for('static', filename='js/logging-dynamic.js') }}?t=1761906276"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v=1762213951"></script>
    <script src="{{ url_for('static', filename='js/app-extensions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jam-client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jam-tab.js') }}"></script>

    <!-- Script for handling mixer iframe loading -->
    <script>
        
        // Set user ID for browser logging if authenticated
        {% if current_user.is_authenticated %}
        setLogUserId({{ current_user.id }});
        {% endif %}
        
        document.addEventListener('DOMContentLoaded', () => {
            // Fonction pour d√©tecter les appareils mobiles
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                    || window.innerWidth <= 768;
            }
            
            // Initialiser Split.js pour le redimensionnement des colonnes (seulement sur desktop)
            let split = null;
            
            if (!isMobileDevice()) {
                split = Split(['#left-panel', '#right-panel'], {
                    sizes: [30, 70],
                    minSize: [200, 400],
                    gutterSize: 10,
                    snapOffset: 0,
                    cursor: 'col-resize',
                    onDrag: function() {
                        // D√©clencher un √©v√©nement de redimensionnement pour mettre √† jour l'iframe du mixer si n√©cessaire
                        window.dispatchEvent(new Event('resize'));
                    }
                });

                // Sauvegarder les tailles des colonnes dans le localStorage
                window.addEventListener('unload', () => {
                    if (split) {
                        localStorage.setItem('split-sizes', JSON.stringify(split.getSizes()));
                    }
                });

                // Restaurer les tailles des colonnes depuis le localStorage
                const savedSizes = localStorage.getItem('split-sizes');
                if (savedSizes) {
                    try {
                        const sizes = JSON.parse(savedSizes);
                        split.setSizes(sizes);
                    } catch (e) {
                        console.error('Erreur lors de la restauration des tailles des colonnes:', e);
                    }
                }
            } else {
                // Sur mobile, appliquer les styles de colonne pleine largeur
                document.getElementById('left-panel').style.width = '100%';
                document.getElementById('right-panel').style.width = '100%';
                document.getElementById('split-main').style.flexDirection = 'column';
            }
            
            // D√©tecter les changements de taille d'√©cran et r√©initialiser si n√©cessaire
            window.addEventListener('resize', () => {
                const nowMobile = isMobileDevice();
                const wasMobile = split === null;
                
                if (nowMobile && !wasMobile && split) {
                    // Passage de desktop √† mobile
                    split.destroy();
                    split = null;
                    document.getElementById('left-panel').style.width = '100%';
                    document.getElementById('right-panel').style.width = '100%';
                    document.getElementById('split-main').style.flexDirection = 'column';
                } else if (!nowMobile && wasMobile) {
                    // Passage de mobile √† desktop
                    location.reload(); // Plus simple de recharger la page
                }
            });
            
            const mixerFrame = document.getElementById('mixerFrame');
            const loadingDiv = document.getElementById('loading');
            const adminFrame = document.getElementById('adminFrame');
            const adminLoadingDiv = document.querySelector('#adminTab .loading');
            
            // Show the iframe once it's loaded
            mixerFrame.onload = function() {
                loadingDiv.style.display = 'none';
                mixerFrame.style.display = 'block';
                
                // Set the iframe height to match its content
                try {
                    // Set a timer to check the content height periodically
                    const checkHeight = () => {
                        try {
                            // Get the document height of the iframe content
                            const frameDoc = mixerFrame.contentDocument || mixerFrame.contentWindow.document;
                            const scrollHeight = Math.max(
                                frameDoc.body.scrollHeight, 
                                frameDoc.documentElement.scrollHeight,
                                frameDoc.body.offsetHeight, 
                                frameDoc.documentElement.offsetHeight
                            );
                            
                            // Set the iframe height to match content (minimum 800px)
                            if (scrollHeight > 800) {
                                mixerFrame.style.height = scrollHeight + 'px';
                            }
                        } catch (e) {
                            console.log('Could not resize iframe: ' + e.message);
                        }
                    };
                    
                    // Check height initially and periodically
                    checkHeight();
                    setInterval(checkHeight, 2000); // Check every 2 seconds
                    
                    // Also listen for window resize events
                    window.addEventListener('resize', checkHeight);
                } catch (e) {
                    console.log('Error setting up iframe resizing: ' + e.message);
                }
            };
            
            // Show the admin iframe once it's loaded
            if (adminFrame) {
                adminFrame.onload = function() {
                    if (adminLoadingDiv) {
                        adminLoadingDiv.style.display = 'none';
                    }
                    adminFrame.style.display = 'block';
                };
            }
            
            // Handle tab switching to ensure iframe loads properly
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.dataset.tab === 'mixer') {
                    button.addEventListener('click', () => {
                        // If iframe hasn't loaded yet, make sure loading indicator is visible
                        if (mixerFrame.style.display === 'none') {
                            loadingDiv.style.display = 'block';
                        }
                    });
                } else if (button.dataset.tab === 'admin' && adminFrame) {
                    button.addEventListener('click', () => {
                        // If admin iframe hasn't loaded yet, make sure loading indicator is visible
                        if (adminFrame.style.display === 'none' && adminLoadingDiv) {
                            adminLoadingDiv.style.display = 'block';
                        }
                    });
                }
            });
        });

        // Mandatory Legal Disclaimer System
        let disclaimerModal = null;
        let acceptDisclaimer = null;
        
        // Check if user has accepted disclaimer
        async function checkDisclaimerStatus() {
            console.log('Checking disclaimer status...');
            
            // Get elements fresh each time
            disclaimerModal = document.getElementById('disclaimerModal');
            acceptDisclaimer = document.getElementById('acceptDisclaimer');
            
            if (!disclaimerModal) {
                console.error('Disclaimer modal not found!');
                return;
            }
            
            if (!acceptDisclaimer) {
                console.error('Accept disclaimer button not found!');
                return;
            }
            
            try {
                const response = await fetch('/api/user/disclaimer-status');
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Disclaimer status:', data);
                
                if (!data.accepted) {
                    console.log('Showing disclaimer modal');
                    disclaimerModal.style.display = 'flex';
                    document.body.classList.add('disclaimer-active');
                } else {
                    console.log('Disclaimer already accepted');
                }
            } catch (error) {
                console.error('Error checking disclaimer status:', error);
                // Show disclaimer on error to be safe
                console.log('Showing disclaimer modal due to error');
                disclaimerModal.style.display = 'flex';
                document.body.classList.add('disclaimer-active');
            }
        }

        // Handle disclaimer acceptance
        function setupDisclaimerHandlers() {
            if (acceptDisclaimer) {
                acceptDisclaimer.addEventListener('click', async () => {
                    console.log('Accept button clicked');
                    try {
                        const response = await fetch('/api/user/accept-disclaimer', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        console.log('Accept API response status:', response.status);
                        
                        if (response.ok) {
                            console.log('Disclaimer accepted, hiding modal');
                            disclaimerModal.style.display = 'none';
                            document.body.classList.remove('disclaimer-active');
                        } else {
                            console.error('Failed to accept disclaimer, status:', response.status);
                        }
                    } catch (error) {
                        console.error('Error accepting disclaimer:', error);
                    }
                });
            } else {
                console.error('Accept disclaimer button not found!');
            }
        }

        // Initialize disclaimer system
        function initDisclaimerSystem() {
            console.log('Initializing disclaimer system...');
            
            disclaimerModal = document.getElementById('disclaimerModal');
            acceptDisclaimer = document.getElementById('acceptDisclaimer');
            
            console.log('Modal found:', !!disclaimerModal);
            console.log('Button found:', !!acceptDisclaimer);
            
            if (disclaimerModal && acceptDisclaimer) {
                setupDisclaimerHandlers();
                checkDisclaimerStatus();
            } else {
                console.error('Disclaimer elements not found, trying again in 1000ms...');
                setTimeout(initDisclaimerSystem, 1000);
            }
        }

        // Check disclaimer status when page loads - ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDisclaimerSystem);
        } else {
            // DOM already loaded
            initDisclaimerSystem();
        }
    </script>

    <!-- Mandatory Legal Disclaimer Modal -->
    <div id="disclaimerModal" class="modal mandatory-modal">
        <div class="modal-content disclaimer-modal">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Legal Disclaimer & Terms of Use</h2>
            </div>
            <div class="modal-body disclaimer-content">
                <div class="disclaimer-section">
                    <h3>ü§ñ AI-Generated Proof of Concept</h3>
                    <p>This application was created entirely by <strong>Claude AI</strong> as a demonstration of artificial intelligence capabilities in software development. The human contributor served solely as a project manager.</p>
                </div>

                <div class="disclaimer-section warning">
                    <h3>‚ö†Ô∏è User Legal Responsibility</h3>
                    <p><strong>BY USING THIS SOFTWARE, YOU ACKNOWLEDGE AND AGREE THAT:</strong></p>
                    <ul>
                        <li><strong>You are solely responsible</strong> for compliance with YouTube Terms of Service</li>
                        <li><strong>You are solely responsible</strong> for compliance with copyright laws in your jurisdiction</li>
                        <li><strong>You will respect</strong> content creators' rights and monetization</li>
                        <li><strong>The developers assume NO liability</strong> for your actions or legal consequences</li>
                    </ul>
                </div>

                <div class="disclaimer-section">
                    <h3>‚úÖ Recommended Legal Uses Only</h3>
                    <ul class="legal-list">
                        <li>Creative Commons licensed content</li>
                        <li>Public domain audio/video</li>
                        <li>Your own original content</li>
                        <li>Open source audio libraries</li>
                        <li>Educational research purposes</li>
                    </ul>
                </div>

                <div class="disclaimer-section">
                    <h3>‚ùå Prohibited Uses</h3>
                    <ul class="prohibited-list">
                        <li>Copyrighted music without explicit permission</li>
                        <li>Commercial distribution of protected content</li>
                        <li>Circumventing content creator monetization</li>
                        <li>Violating platform terms of service</li>
                    </ul>
                </div>

                <div class="disclaimer-section acceptance-section">
                    <p class="disclaimer-note">
                        <strong>By clicking "I Accept and Understand" below, you acknowledge that you have read, understood, and agree to be bound by these terms.</strong>
                    </p>
                    <p class="disclaimer-footer">
                        Full legal details: <a href="https://github.com/benasterisk/StemTube/blob/main/LEGAL_DISCLAIMER.md" target="_blank">Complete Legal Disclaimer</a>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="acceptDisclaimer" class="btn btn-primary accept-btn">
                    <i class="fas fa-check"></i> I Accept and Understand
                </button>
            </div>
        </div>
    </div>
</body>
</html>